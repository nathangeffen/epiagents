<!--
     Epidemiological modelling demonstration: Macro and micro models for
     infectious disease epidemics.

     Copyright (C) 2023  Nathan Geffen

     This program is free software: you can redistribute it and/or modify
     it under the terms of the GNU Affero General Public License as
     published by the Free Software Foundation, either version 3 of the
     License, or (at your option) any later version.

     This program is distributed in the hope that it will be useful,
     but WITHOUT ANY WARRANTY; without even the implied warranty of
     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
     GNU Affero General Public License for more details.

     You should have received a copy of the GNU Affero General Public License
     along with this program.  If not, see <https://www.gnu.org/licenses/>.

     The source code for this project is available here:
     https://github.com/nathangeffen/understandingepi
-->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="author" content="Nathan Geffen">
        <meta name="description" content="Epidemiology: Macro and micro models for infectious disease epidemics">
        <meta name="keywords" content="Epidemiology,models,micro models,macro models,agent-based models,simulation,infectious disease">
        <title>Two types of infectious disease models</title>
        <link rel="stylesheet" href="epi.css?v=3">
    </head>
    <body>

        <!--# include file="contents.html" -->

        <h1>Two ways to model infectious diseases - and what they tell us about epidemics</h1>

        <p>By Nathan Geffen, January 2023</p>

        <p>
            There are many ways to model epidemics, but we can broadly divide
            models into two types: macro and micro. The former typically use a
            set of difference equations to calculate changes in a population,
            while the latter consist of numerous agents, each representing a
            person with their own specific behaviour. Macro models are often
            also called compartmental or equation-based, while micro models are
            often called agent-based or individual-based simulations.
        </p>
        <p>
            At the onset of the Covid pandemic, many websites explained how the
            simplest useful macro model, an SIR one (for
            Susceptible-Infectious-Recovered), worked. We'll start with that and
            then try to implement an equivalent micro model. We'll then discuss
            the differences between the two models and their consequences for
            understanding real-world epidemics. Then we'll implement models of
            HIV and Covid and consider what we can learn about these and other
            infectious diseases from macro and micro models.
        </p>
        <p><i>This page has little asides that you may find useful. They are in
            a gray box. Click the button at the top of the box to expand and read
            an aside.</i>
        </p>
        <aside>
            <button type="button">Using the resources on this webpage</button>
            <div>
                <p>
                    This webpage uses only open-source software. The text on
                    this page is available for republication under <a href="https://creativecommons.org/licenses/by-sa/4.0/">this
                    Creative Commons license</a>.
                    The Javascript and CSS files that I've written for it are available
                    under one the <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">GNU
                    Affero General Public License</a>. My C and C++ code is available
                    under the <a href="https://www.gnu.org/licenses/gpl-3.0.en.html">GNU General Public License</a>. It's
                    all on <a href="https://github.com/nathangeffen/understandingepi">Github</a>.
                    So please feel free to download, adapt, improve and publish as you
                    see fit, but please stick to the terms of the licenses.
                </p>
            </div>
        </aside>
        <aside>
            <button type="button">Terminology</button>
            <div>
                <p>
                    Terminology is inconsistent across infectious disease
                    literature. Macro, micro, compartmental, SIR,
                    equation-based, deterministic, stochastic: all are used to
                    describe types of models. I find the macro vs micro
                    distinction the most useful here, in part because the terms
                    are proper antonyms and using them in the source code makes
                    it easier to read. Also while macro models are usually
                    deterministic, they can be implemented stochastically. And,
                    I suppose, micro models can be implemented
                    deterministically, though a use-case of that doesn't spring
                    to mind.
                </p>
                <p>
                    Macro and micro models are broad categories and there are all
                    manner of models that borrow ideas from both.
                </p>
                <p>
                    For the most part, I try to stick to terminology used in <a href="https://anintroductiontoinfectiousdiseasemodelling.com/">An
                    introduction to Infectious Disease Modelling</a> by Emilia Vynnycky and Richard
                    G White.
                </p>
            </div>
        </aside>

        <h2>A very simple disease</h2>

        <p>
            We start off with a very simple infectious disease. It has the
            following characteristics:
        </p>

        <ol>
            <li>A population of at least 100 people starts off with a tiny
                number of infected people, maybe even just one person.</li>
            <li>People in this population randomly (homogenously) mix with each
                other.</li>
            <lI>When there are a tiny number of infected people in the
                population, they will on average infect two other people before
                they recover.</li>
            <li>Infected people on average take 5 days to recover.</li>
            <li>Once recovered, a person has immunity. They can't become
                infected again and they can't transmit the infection to anyone else.</li>
        </ol>

        <p>No-one dies and there are no births or migration into or out of this
            population, at least for the time period that we model.</p>

        <p>
            Characteristic 3 of our model is what's commonly called
            $\underline{R}_0$ in epidemiological literature. The real-world use
            of $\underline{R}_0$ is much more limited than is usually admitted
            but it's still useful.
        </p>

        <p>
            We call our description above a model world. We can implement both a
            macro or a micro model version of it.
        </p>

        <p>
            In this population we have people who are <b>S</b>usceptible to the
            infection, but not yet infected. There are infected people, and all
            infected people also <b>I</b>nfectious. And we have <b>R</b>ecovered people.
            That's three compartments: Susceptible, Infectious and Recovered, abbreviated as SIR.
        </p>
        <p>
            We initialize our model so that nearly everyone in the population is
            uninfected and has never had the infection. In other words everyone
            is in the Susceptible compartment and a tiny number are in the
            Infectious compartment.
        </p>
        <p>
            Let's assume the population size is 100. Then we'll set $S$, the
            number of people in the Susceptible compartment to 99 and $I$, the
            number of people in the Infectious compartment to 1. The number of
            people, $R$, in the Recovered compartment is 0. (Note we do not
            underline ${R}$, the number of recovered people, to differentiate it
            from $\underline{R}_0$, the number of people that each infectious
            person will infect when the epidemic is still very small. I wish
            this was a standard adopted throughout infectious disease
            literature.)
        </p>
        <p>
            All the above is common to both the macro and micro models that we
            implement. Now let's describe specific details of our macro model:
        </p>

        <h3>SIR Macro model</h3>

        <p>
            We iteratively update the $S$, $I$ and $R$ compartments with the
            number of people who have moved between them. In our model each
            iteration represents a day in our infectious disease world. These
            equations describe what happens on each iteration:
        </p>

        <p>
            Note that the number of people in our macro model compartments are
            continuous real numbers, not discrete. This is a big difference
            between our macro and micro models.
        </p>

        <p>
            The number of people who become infected on each iteration, or day,
            of our model is a function of S, I and the risk of infection $\lambda$.
            Since all three of these variables change with time, we subscript them.
            This equation describes the flow from $S$ to $I$:

            \begin{equation}
            S_{t+1}=S_t - \lambda_t S_t
            \end{equation}
        </p>

        <p>
            Since people mix homogenously, we have:

            \begin{equation} \lambda_t = \beta I_t \end{equation}

            where

            \begin{equation} \beta = {\underline{R}_0 \over {ND}} \end{equation}

            where $N$ is the population size and $D$ is the average number of
            days a person is infected (5 in our model).
        </p>

        <p>
            The other equations in the model are simple:
        </p>
        <p>
            \begin{equation}
            I_{t+1}=I_t + \lambda_t S_t - rI_t
            \end{equation}

            \begin{equation}
            R_{t+1}=R_t + rI_t
            \end{equation}

            where $r$ is the rate of recovery per day, or $1/5$ in our model.
        </p>

        <p>
            We can depict what happens on each time step (or day) graphically:
        </p>

        <p>
            <img src="sir.svg" alt="Basic SIR graph">
        </p>


        <div id="macroSIR" class="sir"></div>

        <p>There are four boxes shown in each model:
        </p>
        <dl>
            <dt>Outputs</dt>
            <dd>This shows the population size of each compartment after each
                iteration of a model.</dd>

            <dt>Parameters</dt>
            <dd>
                You can change the parameters before running a model. Press the <em>Reset</em> button to set the parameters to their original values.
            </dd>

            <dt>Graph</dt>
            <dd>This shows how the compartment population sizes change over
                time.</dd>

            <dt>Population</dt>
            <dd>This shows the status of the individuals in the population. This
                makes much more sense for micro models. In macro models you usually
                have fractions of individuals, so we round off. Also our macro
                models are deterministics so all the individuals in a particular
                compartment are grouped together. </dd>
        </dl>

        <p>Adjust the speed slider to make the model run faster or slower.</p>

        <p>Click the <em>Run</em> button to run a model. It changes to a <em>Stop</em> button
            while the model is running so that you can interrupt the model. This
            is useful if it's taking too long.</p>

        <h3>SIR micro model</h3>

        <p>Now let's implement a micro model that approximates the above macro model.</p>

        <p>
            A micro model consists of agents and events. An agent typically
            represents a single person in a population. An event typically is
            executed on a subset of agents.
        </p>

        <p>
            There are three stages to executing a micro model: <em>before</em> events,
            <em>during</em> events and <em>after</em> events.
        </p>
        <p>
            First execute the
            <em>before</em> events. These typically would create and initialise
            the agents, write a report of the initial state of the population
            and perhaps calculate some working variables that won't change once
            the simulation starts. </p>
        <p>
            Then repeatedly execute the <em>during</em> events until some stop
            condition is met. A simple stop condition is simply to execute the
            during events $n$ times, where $n$ is a user-defined constant. Typical
            during events would shuffle the agents (to generate more
            stochasticity), infect some susceptibe agents, vaccinate some
            agents, recover some infected agents, or kill some ill agents.</p>
        <p>
            Finally execute the after events which would typically be writing a
            report or creating a CSV file of the outputs.
        </p>

        <p>Here is the structure of the micro models I tend to implement</p>

        <pre>
Execute before events
# Simulation loop:
Loop n times:
   for each during event, e:
       For each agent, a:
           If e should be applied to a:
              e(a)
Execute after events
        </pre>

        <p>Here is a micro model for SIR</p>

        <div id="microSIR" class="sir"></div>

        <p>Try running the above two models multiple times. What do you notice?</p>

        <p>
            Even with these two models of our simple model world, there are
            already interesting observations we can make:
        </p>

        <ul>
            <li>
                The macro model obviously gives the same outputs every time.
                It's entirely deterministic. The micro model seldom repeats
                exactly the same outputs.
            </li>
            <li>
                With the parameters used here, the infectious disease in the
                micro model often fails to take off; no one besides the
                originally infected agent becomes infected.
            </li>
            <li>
                The macro model epidemic ends with about 809 people in the
                recovery compartment, meaning this many people were infected.
                The micro model epidemic on average has far fewer infections.
                This is because with just one initial infection it often fails
                to "take off".
            </li>
        </ul>

        <p>
            I ran the micro model 100 times. In some simulations, there are no
            new infections. The most number of infections in a simulation was
            856 infections, higher than the macro model. But the mean number of
            total infections across the simulations was only 472, compared to
            804 in the macro model. One thing of real-world consequence that
            this suggests is that if and when an infectious diseases explodes
            into an epidemic in a particular community or neighbourhood is, to
            a great extent, a result of chance, even if an infected person enters
            the community.
        </p>

        <p>
            Here are the two models again but with one difference: the number of
            infections in the initial population is 100 instead of 1.
        </p>

        <p>First the macro model: </p>
        <div id="macroSIR100" class="sir"></div>
        <p>Now the micro model: </p>
        <div id="microSIR100" class="sir"></div>

        <aside>
            <button type="button">How to run the micro models many times</button>
            <div>
                <p>
                    You could press the Run button on a micro model 100 times
                    and tabulate the outputs each time, but there's a much
                    easier way.
                </p>
                <ol>
                    <li>Open an interactive Javascript console in your browser.
                    On Firefox or Chromium I press CTRL-SHIFT-C and then click
                    on the console tab.
                    </li>
                    <li>
                        Then execute this code:
                        <pre>
series = EpiMicro.runSimulations(microSIR100, 100);
EpiMicro.stat(series, -1, 'R', EpiMicro.min);
EpiMicro.stat(series, -1, 'R', EpiMicro.max);
EpiMicro.stat(series, -1, 'R', EpiMicro.mean);
                        </pre>
                        The first line runs the microSIR100 model 100 times. The
                        next three lines get the min, max and mean of the final
                        value of the recoveries in the model.
                    </li>
                    <li>
                        To change the initial values of the model's
                        compartments, you can do something like this:
                        <pre>
// Change the number of initial susceptible agents to 990
microSIR100.compartments.S = 990;
// Change the number of initial infected agents to 10
microSIR100.compartments.I = 10;
                        </pre>
                    </li>
                    <li>
                        To change the model's parameters, you can first view them like so:
                        <pre>
microSIR.parameters;
                        </pre>
                        And then modify them as appropriate.
                    </li>
                </ol>
                <p>
                    You can do the above with any of the models. All the model
                    names and their descriptions are stored in the
                    EpiUI.modelRegister variable. Obviously the macro models
                    give the same min, max and mean every time you run them.
                </p>
            </div>
        </aside>

        <p>
            Now running the micro model 100 times yields a mean of 843
            infections per simulation &mdash; you may get a slightly different
            answer each time you run it &mdash; about the same as the macro
            model's 842. The minimum number of infections in these 100
            simulations was 767 and the maximum was 892. Again, your outputs
            will likely differ a little.
        </p>

        <p>
            Play around with the other parameters, $\underline{R}_0$ and $D$, to
            see how changing these changes the models' outputs.
        </p>

        <aside>
            <button type="button">What programming language to use for micro models?</button>
            <div>
                <p>
                    There is far more debate on the Internet about which are the
                    best programming languages than the topic deserves. In fact,
                    there are many good programming languages and all of them
                    are flawed. Write your first simulations in a programming
                    language you feel comfortable with. If it's a prototype it
                    doesn't matter if it's Python, R, Ruby, Basic or whatever
                    your favourite algebra for expressing algorithms is.
                </p>
                <p>
                    If you need your simulation to execute many thousands of
                    times and you are finding it too slow, changing to a
                    compiled language like C, C++, Go, Fortran, Rust, Java or
                    even a lisp-type language, may be necessary. But often the
                    cause of execution being too slow isn't the language but an
                    algorithm you might be using. Perhaps consider optimising or
                    improving an algorithm before going to the effort of
                    learning a new programming language.
                </p>
                <p>For what it's worth I tend to implement my micro models in Python
                    when I'm just prototyping and then C or C++ if I truly need a
                    lot more speed. But the models on this webpage are of course all
                    implemented in Javascript, because that is the main programming
                    language that the most popular web browsers support.
                </p>
            </div>
        </aside>

        <h3>Using differential equations</h3>

        <p>
            Instead of implementing a macro model as a series of
            <em>difference</em>
            equations, we could instead use <em>differential</em> equations.
            There are advantages to this approach:
        </p>
        <ul>
            <li>Adv 1</li>
            <li>Adv 2</li>
        </ul>

        <p>Recasting our difference equations as differential equations, we get:

            \begin{equation}
            \frac{dS}{dt} = -\beta I(t) S(t)
            \end{equation},

            \begin{equation}
            \frac{dI}{dt} = \beta I(t) S(t) - r I(t)
            \end{equation}

            and

            \begin{equation}
            \frac{dR}{dt} =  r I(t)
            \end{equation}

        </p>

        <div id="macroSIROde" class="sir"></div>

        <h3>Adding an exposure compartment</h3>

        <p>
            Let's get a bit more complicated. We change our model world so that
            there's an exposure compartment before an infectious one. When
            exposed a person is infected, but not infectious. In our model world
            the average exposure period is two days. This is an SEIR model.
        </p>

        <p>
            <img src="seir.svg" alt="SEIR graph">
        </p>

        <p>
            Here's the macro model version of SEIR:
        </p>
        <div id="macroSEIR" class="sir"></div>
        <p>
            Here's the micro model version of SEIR.
        </p>
        <div id="microSEIR" class="sir"></div>

        <p>
            I ran the macro model once and the micro model 1000 times with the
            number of initial exposures set to 1, 10, 50 and 100, and the
            initial susceptibles equal to 999, 990 950 and 900 respectively.
        </p>
        <p>
            Below are the results. As usual, because the micro model is
            stochastic, your results will probably differ a little.
        </p>
        <table>
            <tr>
                <th>
                </th>
                <th>
                    Macro model
                </th>
                <th colspan="3">
                    Micro model (1000 simulations)
                </th>
            </tr>
            <tr>
                <th>
                    Exposed at start
                </th>
                <th>
                    Infections
                </th>
                <th>
                    Mean
                </th>
                <th>
                    Min
                </th>
                <th>
                    Max
                </th>
            </tr>
            <tr>
                <td>
                    1
                </td>
                <td>
                    796
                </td>
                <td>
                    382
                </td>
                <td>
                    1
                </td>
                <td>
                    856
                </td>
            </tr>
            <tr>
                <td>
                    10
                </td>
                <td>
                    808
                </td>
                <td>
                    803
                </td>
                <td>
                    28
                </td>
                <td>
                    879
                </td>
            </tr>
            <tr>
                <td>
                    50
                </td>
                <td>
                    822
                </td>
                <td>
                    819
                </td>
                <td>
                    729
                </td>
                <td>
                    891
                </td>
            </tr>
            <tr>
                <td>
                    100
                </td>
                <td>
                    838
                </td>
                <td>
                    837
                </td>
                <td>
                    736
                </td>
                <td>
                    915
                </td>
            </tr>
        </table>

        <p>
            The results are consistent with what we see for the SIR models.
        </p>

        <h2>
            Modelling when to start HIV treatment
        </h2>
        <p>
            In the late 2000s there was a feisty discussion about when was the
            best time for people with HIV to start antiretroviral treatment.
            Antiretroviral pills taken daily for life reduced the number of HIV
            virions in the blood of infected people, usually to undetectable
            levels. This brought two potential advantages: (1) it extended the
            life-expectancy to almost normal and (2) it reduced the risk of
            transmitting the virus to others.
        </p>
        <p>
            But the ideal time to start treatment wasn't clear. Three concerns
            affecting this were (1) the side effects of the drugs, (2) eventual
            drug resistance and (3) the cost of the drugs. By the mid 20-teens
            large well-conducted clinical trials had shown the benefit of
            starting treatment as soon as a person was diagnosed were
            substantial. Moreover drug resistance and serious side effects with
            newer antiretroviral regimens have become minor problems.
        </p>
        <p>
            Nevertheless in the late 2000s all of this was unclear. World Health
            Organisation researchers (Granich et al. 2009) published models in <a href="https://www.sciencedirect.com/science/article/abs/pii/S0140673608616979">The Lancet</a> that
            showed that a policy of actively testing and immediately treating
            people with HIV in South Africa, the state with the most number of
            people with this virus in the world, would reduce the country's HIV
            prevalence to a negligible level in 50 years.
        </p>
        <p>
            The paper certainly made a splash, evoking voiceferous discussion.
            According to Google Scholar it has been cited over 2,300 times. I
            suspect that until the Covid-19 pandemic it was the most highly
            cited infectious disease model ever.
        </p>
        <p>
            The graphic with its accompanying caption below, copied from the
            Granich paper in The Lancet, describes one of their models.
        </p>

        <figure>
            <img src="GranichEtAlModel.png" />
            <figcaption>From <a href="https://www.sciencedirect.com/science/article/abs/pii/S0140673608616979">Granich et al. 2009</a></figcaption>
        </figure>

        <p>
            This models a world much more complex than our previous models. It
            accounts for population growth and deaths. The model specification
            has 10 compartments and another 10 parameters. Here is my
            implementation of the Granich model.
        </p>

        <div id="macroGranichEtAl" class="sir"></div>

        <p>We can quite easily implement a microsimulation version of this.</p>
        <div id="microGranichEtAl" class="sir"></div>


        <p>Here is a quick and dirty Covid-like-disease model.</p>
        <div id="macroCovid" class="sir"></div>

        <p>Here is the equivalent micro model.</p>
        <div id="microCovid" class="sir"></div>

        <footer>
            <nav>
                <a href="COPYING">License</a>
                <a href="https://github.com/nathangeffen/understandingepi">Source code</a>
                <a href="https://www.simhub.online">Simhub</a>
            </nav>
            <p>
                <a href="https://www.gnu.org/licenses/agpl-3.0.html">Copyright</a>
                &copy; 2023 Nathan Geffen
            </p>
        </footer>

        <script src="utils.js?v=20221111"></script>
        <script src="rk.js?v=20230101"></script>
        <script src="epimacro.js?v=20221111"></script>
        <script src="epimicro.js?v=20221111"></script>
        <script src="epi-ui.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script id="MathJax-script" async
                src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js">
        </script>
        <script src="models.js"></script>

    </body>
</html>
